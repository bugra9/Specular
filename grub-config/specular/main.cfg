source $cfgdir/set_video.cfg
source $cfgdir/set_root.cfg
source $cfgdir/export.cfg

function mainmenu_reload {
    configfile $cfgdir/main.cfg
}
function getVar {
	load_env --file $cfgdir/isoenv "$1_$isolabelsafe"
	set name="\$$1_$isolabelsafe"
	eval "set $1=\"${name}\""
	export "$1"
}
function setVar {
	set "$1_$isolabelsafe"="$2"
	save_env --file $cfgdir/isoenv "$1_$isolabelsafe"
}

load_env def_timezone def_keyboard def_bootlang def_persistenceType

set persistenceType="file"
if [ "x$persistentFS" = "xext2" ]; then
	if [ "x${def_persistenceType}" = "xfile" ]; then
		set persistenceType="file"
	else
		set persistenceType="filesystem"
	fi
fi

submenu "Linux Kalıpları" {
	insmod regexp
	insmod part_msdos

	for i in $isoDir/*.iso ; do
		regexp -s w '^.*/(.*).iso' $i 
		submenu "$w" $i {
			set isofile="$2"	
			loopback loop $isofile
			probe -l loop --set=isolabel
			probe -u $root --set=uuid
			set imgdevpath="/dev/disk/by-uuid/$uuid"
			tr -s isolabelsafe " " "_" "$isolabel"
			tr -s isolabelsafe ":" "_" "$isolabelsafe"
			tr -s isolabelsafe "." "_" "$isolabelsafe"

			set opt=""
			for cfgfile in $cfgdir/distro/*.cfg; do
				source "$cfgfile"
				if [ x$opt != "x" ]; then
					break
				fi
			done

			for cfgfile in $cfgdir/initrd/*.cfg; do
				source "$cfgfile"
			done

			source "$cfgdir/linuxMenu.cfg"
		}
	done
}

if [ -s /bootmgr ]; then
	menuentry "Windows Kurulumu" {
		if [ "${grub_platform}" == "pc" ]; then
			insmod part_msdos
	    insmod ntfs
			ntldr /bootmgr
			boot
		else
			insmod ntfs
			if [ -s /EFI/Microsoft/Boot/bootmgfw.efi ]; then
				chainloader /EFI/Microsoft/Boot/bootmgfw.efi
			elif [ -s /EFI/Boot/bootx64.efi ]; then
				chainloader /EFI/Boot/bootx64.efi
			elif [ -s /specular/tools/win7_x64.efi ]; then
				chainloader /specular/tools/win7_x64.efi
			else
				echo "Başlatılacak EFI dosyası bulunamadı."
			fi
			boot
		fi
	}
fi

menuentry "Kurulu İşletim Sistemleri" {
	insmod regexp
	insmod part_msdos
	for x in (hd1,*) ; do
		if [ -f "$x/boot/grub/grub.cfg" ] ; then
			configfile $x/boot/grub/grub.cfg
			break
		fi
	done
}

submenu "Ayarlar" {
	set root=$part1
	configfile $cfgdir/settings.cfg
}

menuentry "Yeniden Başlat" {
	reboot
}
